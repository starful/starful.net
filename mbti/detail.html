<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <style type="text/css">
    form {
        margin: 5% 15% 5% 15%;
        width: 70%;
    }

    .toListButton {
        width: 12%;
        height: 60px;
        border-radius: 6px 6px 6px 6px;
        background-color: #0462bd;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #0462bd;
        font-size: x-large;
        margin: 0% 0% 0% 15%;
    }

    .modifyButton {
        width: 12%;
        height: 60px;
        border-radius: 6px 6px 6px 6px;
        background-color: #4b9dea;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #4b9dea;
        font-size: x-large;
        margin: 0% 0% 0% 33%;
    }

    .deletebbsButton {
        width: 12%;
        height: 60px;
        border-radius: 6px 6px 6px 6px;
        background-color: #72b1ed;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #72b1ed;
        font-size: x-large;
        margin: 0% 0% 0% 0%;
    }

    .commentUpdateCancelButton {
        width: 8%;
        height: 25px;
        border-radius: 6px 6px 6px 6px;
        background-color: #a1bcd6;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #a1bcd6;
        font-size: small;
        margin: 2% 0% 1% 83%;
    }

    .commentUpdateButton {
        width: 8%;
        height: 25px;
        border-radius: 6px 6px 6px 6px;
        background-color: #6e99c2;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #6e99c2;
        font-size: small;
        margin: 2% 0% 1% 0%;
    }

    .displayNone {
        display: none;
    }

    .commentButton {
        width: 12%;
        height: 60px;
        border-radius: 6px 6px 6px 6px;
        background-color: #034f96;
        color: #fff;
        box-shadow: 0 0 10px rgb(102 179 251 / 50%);
        border-color: #034f96;
        font-size: x-large;
        margin: 2% 0% 0% 88%;
    }

    .mousepointer-hand {
        cursor: pointer;
    }

    img {
        width: 20px;
        height: 20px;
        margin-right: 13px;
    }

    textarea {
        resize: none;
    }
    </style>
    <script type="text/javascript">
    /********************************** modify Button click   **********************************/
    function modify() {
        window.location.href = "https://starful.net/mbti/modify.html"
    }
    /********************************** toList Button click   **********************************/
    function toList() {
        window.location.href = "https://starful.net/mbti/mbtiBBS.html"
    }
    /********************************** Delete BBS   **********************************/
    function deletebbs() {
        id = sessionStorage.getItem('id');
        data = { "id": id };
        json = JSON.stringify(data);
        $.ajax({
            type: "POST",
            url: "https://starful.net/api/mbti/setDelete",
            data: json,
            contentType: "application/json",
            success: function(datas) {
                window.location.href = "https://starful.net/mbti/mbtiBBS.html"
            },
            error: function(msg) {
                console.log("error");
            }
        });
    }

    /********************************** commentModifyImageClick   **********************************/
    function commentModifyImageClick(value) {
        var target = '#comment' + value + ''
        var commentUpdateCancelButtonTarget = '#commentUpdateCancelButton' + value + ''
        var commentUpdateButtonTarget = '#commentUpdateButton' + value + ''
        $(target).prop('disabled', false);
        $(target).removeClass('form-control-plaintext');
        $(target).addClass('form-control');
        $(commentUpdateCancelButtonTarget).removeClass('displayNone');
        $(commentUpdateButtonTarget).removeClass('displayNone');
    }

    /********************************** Comment Update Cancel Button click   **********************************/
    function commentUpdateCancel(value) {
        var target = '#comment' + value + ''
        var commentUpdateCancelButtonTarget = '#commentUpdateCancelButton' + value + ''
        var commentUpdateButtonTarget = '#commentUpdateButton' + value + ''
        $(target).prop('disabled', true);
        $(target).removeClass('form-control');
        $(target).addClass('form-control-plaintext');
        $(commentUpdateCancelButtonTarget).addClass('displayNone');
        $(commentUpdateButtonTarget).addClass('displayNone');
    }

    /********************************** Comment Update  **********************************/
    function commentUpdate(value) {
        var comment_textarea = document.getElementById('comment' + value);
        if (trimfield(comment_textarea.value) == '') {
            alert("Please enter the comment");
            return false;
        } else {
            var target = '#comment' + value + ''
            id = value;
            comment = $(target).val();
            data = { "id": id, "comment": comment };
            json = JSON.stringify(data);
            $.ajax({
                type: "POST",
                url: "https://starful.net/api/mbti/updateComment",
                data: json,
                contentType: "application/json",
                success: function(datas) {
                    window.location.href = "https://starful.net/mbti/detail.html"
                },
                error: function(msg) {
                    console.log("error");
                }
            });
        }
    }
    /********************************** Comment Delete image click  **********************************/
    function commentDeleteImageClick(value) {
        sessionStorage.setItem('deleteId', value);
    }
    /********************************** Comment Delete  **********************************/
    function commentDelete() {
        id = sessionStorage.getItem('deleteId');
        data = { "id": id };
        json = JSON.stringify(data);

        $.ajax({
            type: "POST",
            url: "https://starful.net/api/mbti/deleteComment",
            data: json,
            contentType: "application/json",
            success: function(datas) {
                window.location.href = "https://starful.net/mbti/detail.html"
            },
            error: function(msg) {
                console.log("error");
            }
        });
    }

    function trimfield(str) {
        return str.replace(/^\s+|\s+$/g, '');
    }

    $(document).ready(function() {

        /********************************** BBS GET DATA  **********************************/
        kind = sessionStorage.getItem('kind');
        id = sessionStorage.getItem('id');
        data = { "kind": kind, "id": id };
        json = JSON.stringify(data);

        var target = '#result';
        var target_comments = '#comments';
        var insert = '';
        var comments = '';

        $.ajax({
            type: "POST",
            url: "https://starful.net/api/mbti/getDetail",
            data: json,
            contentType: "application/json",
            success: function(datas) {
                console.log(datas);

                /********************************** MAKE HTML (BBS)  **********************************/
                insert += ' <label>' + datas['datas'][0]["kind"] + '</label>'
                insert += ' <label> | </label>'
                insert += ' <label>' + datas['datas'][0]["reg_user"] + '</label>'
                insert += ' <label> | </label>'
                insert += ' <label>' + datas['datas'][0]["reg_datetime"] + '</label>'
                insert += ' <label> | </label>'
                insert += ' <label>' + datas['datas'][0]["update_datetime"] + '</label>'
                insert += ' <label> | </label>'
                insert += ' <label for=""> Comment </label>'
                insert += ' <span class="badge rounded-pill bg-primary">' + datas['count'][0]['count'] + '</span>'

                $("#title").val(datas['datas'][0]["title"]);
                $("#contents").val(datas['datas'][0]["contents"]);
                $(target).append(insert);
                $("#result").show();

                /********************************** MAKE HTML (COMMENTS)  **********************************/
                comments += ' '
                for (var i = 0; i < datas["comments"].length; i++) {
                    comments += ' <div class="form-group form-control">'
                    comments += ' <label> ' + datas['comments'][i]["reg_user"] + ' </label>'
                    comments += ' <label> | </label>'
                    comments += ' <label> ' + datas['comments'][i]["reg_datetime"] + ' </label>'
                    comments += ' <label> | </label>'
                    comments += ' <label> ' + datas['comments'][i]["update_datetime"] + ' </label>'
                    comments += ' <img src="../img/mbti/delete.png" class="rounded float-end mousepointer-hand" data-bs-toggle="modal" data-bs-target="#deleteCheckModal" onclick="commentDeleteImageClick(' + datas['comments'][i]["id"] + ')">'
                    comments += ' <img src="../img/mbti/modify.png" class="rounded float-end mousepointer-hand" onclick="commentModifyImageClick(' + datas['comments'][i]["id"] + ')">'
                    comments += ' <textarea class="form-control-plaintext bg-white" id="comment' + datas['comments'][i]["id"] + '" rows="3" disabled="true"> ' + datas['comments'][i]["comments"] + ''
                    comments += ' </textarea>'
                    comments += ' <button class="commentUpdateCancelButton displayNone" type="submit" id="commentUpdateCancelButton' + datas['comments'][i]["id"] + '" onclick="commentUpdateCancel(' + datas['comments'][i]["id"] + ');return false">Cancel</button>'
                    comments += ' <button class="commentUpdateButton displayNone" type="submit" id="commentUpdateButton' + datas['comments'][i]["id"] + '" onclick="commentUpdate(' + datas['comments'][i]["id"] + ');return false">End</button>'
                    comments += ' </div>'
                }

                $(target_comments).append(comments);
                $("#comments").show();
            },
            error: function(msg) {
                console.log("error");
            }
        });
        /********************************** Insert Comment validation check & Insert Comment **********************************/
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === true) {
                        id = sessionStorage.getItem('id');
                        kind = sessionStorage.getItem('kind');
                        comment = $("#comment").val();
                        user = "testUser"
                        data = { "id": id, "kind": kind, "comment": comment, "user": user };
                        json = JSON.stringify(data);

                        $.ajax({
                            type: "POST",
                            url: "https://starful.net/api/mbti/insertComment",
                            data: json,
                            contentType: "application/json",
                            success: function(datas) {
                                window.location.href = "https://starful.net/mbti/detail.html"
                            },
                            error: function(msg) {
                                console.log("error");
                            }
                        });
                    } else {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);


    });
    </script>
</head>

<body>
    <!------------------------------------------ BBS area ------------------------------------------>
    <form class="needs-validation" novalidate>
        <div id="result" class="form-group text-end">
        </div>
        <div class="form-group">
            <label for="title">◆Title</label>
            <input type="text " class="form-control-plaintext form-control-lg bg-white" id="title" disabled="true">
            <div class="valid-feedback">Looks good!</div>
        </div>
        <div class="form-group">
            <label for="contents">◆Contents</label>
            <textarea class="form-control-plaintext bg-white" id="contents" rows="10" disabled="true"></textarea>
        </div>
    </form>
    <button class="toListButton" onclick="toList()">ToList</button>
    <button class="modifyButton" onclick="modify()">modify</button>
    <button class="deletebbsButton" onclick="deletebbs()">delete</button>
    <!------------------------------------------ comments make html area ------------------------------------------>
    <form>
        <div id="comments">
        </div>
    </form>
    <!------------------------------------------ comment reg ------------------------------------------>
    <form class="needs-validation" novalidate>
        <div class="form-group">
            <input type="text" class="form-control" id="comment" placeholder="comment" required>
            <div class="valid-feedback">Looks good!</div>
        </div>
        <button class="btn btn-primary commentButton" id='insert' type="submit">Insert</button>
    </form>
    <!------------------------------------------ Button trigger modal ------------------------------------------>
    <div class="container">
        <div class="modal fade" id="deleteCheckModal" tabindex="-1" aria-labelledby="deleteCheckLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteCheckLabel">Deletion confirmation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Do you really want to delete this Comment?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="commentDelete()">delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>